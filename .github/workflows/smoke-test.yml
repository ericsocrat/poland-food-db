# ═══════════════════════════════════════════════════════════════════════════════
# Post-Deploy Smoke Test — Verify production health after deployment
# ═══════════════════════════════════════════════════════════════════════════════
# Triggered automatically after a successful Vercel deployment.
# Hits the /api/health endpoint and validates the response shape.
# Also checks critical page routes return 200.
#
# If the smoke test fails, the deployment is marked as failed and an alert
# is generated. This catches:
#   • Broken builds that somehow passed CI
#   • Environment variable misconfiguration
#   • Supabase connectivity issues post-deploy
#   • Missing/broken API routes
#
# For Vercel deployments, deployment_status events fire automatically.
# The workflow also supports manual trigger for ad-hoc health checks.
# ═══════════════════════════════════════════════════════════════════════════════

name: Post-Deploy Smoke Test

on:
  deployment_status:
  workflow_dispatch:
    inputs:
      target_url:
        description: "URL to smoke test (e.g. https://your-app.vercel.app)"
        required: true
        type: string

permissions:
  contents: read
  deployments: read

concurrency:
  group: smoke-test-${{ github.event.deployment.id || 'manual' }}
  cancel-in-progress: true

jobs:
  smoke:
    name: Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 5

    # Run on successful deployment OR manual trigger
    if: >-
      (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success') ||
      github.event_name == 'workflow_dispatch'

    env:
      TARGET_URL: ${{ github.event.deployment_status.target_url || github.event.inputs.target_url }}

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 10

      - name: Verify target URL
        run: |
          if [ -z "$TARGET_URL" ]; then
            echo "::error::No target URL available"
            exit 1
          fi
          echo "Smoke testing: $TARGET_URL"

      # ── Health endpoint (deep check) ─────────────────────────────────
      - name: Health check — /api/health
        run: |
          echo "## Post-Deploy Smoke Test" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Target:** \`$TARGET_URL\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          response=$(curl -sf --max-time 15 "$TARGET_URL/api/health" 2>&1) || {
            echo "| /api/health | ❌ Connection failed |" >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Health endpoint unreachable at $TARGET_URL/api/health"
            exit 1
          }

          # Parse status from JSON response
          status=$(echo "$response" | python3 -c "import sys,json; print(json.load(sys.stdin).get('status','unknown'))" 2>/dev/null || echo "parse_error")

          echo "| Route | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"

          if [ "$status" = "healthy" ] || [ "$status" = "degraded" ]; then
            echo "| /api/health | ✅ $status |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| /api/health | ❌ $status |" >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Health check returned status: $status"
            echo "Response: $response"
            exit 1
          fi

      # ── Critical page routes (HTTP 200 check) ───────────────────────
      - name: Check critical routes
        run: |
          failed=0
          routes=("/" "/app" "/app/scan")

          for route in "${routes[@]}"; do
            status_code=$(curl -so /dev/null -w "%{http_code}" --max-time 15 "$TARGET_URL$route" 2>/dev/null)
            if [ "$status_code" -ge 200 ] && [ "$status_code" -lt 400 ]; then
              echo "| $route | ✅ $status_code |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| $route | ❌ $status_code |" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::Route $route returned HTTP $status_code"
              failed=1
            fi
          done

          if [ "$failed" -ne 0 ]; then
            exit 1
          fi

      # ── Response time baseline ───────────────────────────────────────
      - name: Measure response times
        if: ${{ !cancelled() }}
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Response Times" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Route | Time (ms) |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-----------|" >> "$GITHUB_STEP_SUMMARY"

          routes=("/" "/api/health")
          for route in "${routes[@]}"; do
            time_ms=$(curl -so /dev/null -w "%{time_total}" --max-time 15 "$TARGET_URL$route" 2>/dev/null | awk '{printf "%.0f", $1 * 1000}')
            echo "| $route | ${time_ms}ms |" >> "$GITHUB_STEP_SUMMARY"

            # Warn if response time > 3 seconds
            if [ "$time_ms" -gt 3000 ]; then
              echo "::warning::Slow response: $route took ${time_ms}ms"
            fi
          done

      - name: Summary
        if: ${{ !cancelled() }}
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "✅ **Post-deploy smoke test passed.**" >> "$GITHUB_STEP_SUMMARY"

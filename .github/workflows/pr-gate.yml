# ═══════════════════════════════════════════════════════════════════════════════
# PR Gate — Fast feedback for pull requests
# CI Architecture Redesign — replaces build.yml + ci.yml on PR events
# ═══════════════════════════════════════════════════════════════════════════════
# Parallel job graph:
#   static-checks ──┬── unit-tests
#                    └── build ── e2e-smoke
#
# Target runtime: < 5 minutes
# Fork-safe: all secret-dependent steps are explicitly guarded.
# ═══════════════════════════════════════════════════════════════════════════════

name: PR Gate

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  # ── CI runtime observability baselines (seconds) ─────────────────────────
  BASELINE_STATIC: 90
  BASELINE_UNIT: 180
  BASELINE_BUILD: 120
  BASELINE_SMOKE: 300

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Job 1: Static analysis (typecheck + lint) — runs first, fails fast
  # ─────────────────────────────────────────────────────────────────────────
  static-checks:
    name: Typecheck & Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      # ── Enhancement D: lightweight security hygiene scan ───────────────
      - name: Security hygiene scan
        working-directory: .
        run: |
          failed=0

          # 1. Fail if any workflow uses supabase link with a bare hardcoded ref
          #    (not wrapped in a secrets expression). Ignores comments and this scan.
          hits=$(grep -rEn 'supabase link --project-ref' .github/workflows/ \
            | grep -vE '\$\{\{|^\s*#|grep|echo' || true)
          if [ -n "$hits" ]; then
            echo "$hits"
            echo "::error::Hardcoded Supabase project ref found in workflow files"
            failed=1
          fi

          # 2. Check for obvious secret/token patterns in committed source files
          hits=$(grep -rEn --include='*.ts' --include='*.tsx' --include='*.js' --include='*.json' \
            'sk_live_|sk_test_|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\.' \
            . 2>/dev/null | grep -vE 'node_modules|\.next' | head -5 || true)
          if [ -n "$hits" ]; then
            echo "$hits"
            echo "::error::Potential secret/token pattern found in source files"
            failed=1
          fi

          if [ "$failed" -ne 0 ]; then exit 1; fi
          echo "✓ Security hygiene scan passed"

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: TypeScript type-check
        run: npx tsc --noEmit
        timeout-minutes: 3

      - name: ESLint
        run: npx next lint
        timeout-minutes: 3

      # ── Dependency audit (informational — dedicated workflow is the gate) ──
      - name: npm audit (warn only)
        run: npm audit --omit=dev --audit-level=high 2>&1 || echo "::warning::npm audit found vulnerabilities — see dependency-audit workflow for details"
        continue-on-error: true

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        working-directory: .
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## Typecheck & Lint: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_STATIC" -gt 0 ] && pct=$(( (d-BASELINE_STATIC)*100/BASELINE_STATIC ))
          [ "$pct" -gt 30 ] && echo "::warning::Static checks regression: ${d}s (+${pct}% vs ${BASELINE_STATIC}s)"
          mkdir -p ci-timings
          echo '{"job":"static-checks","duration_seconds":'$d',"baseline_seconds":'$BASELINE_STATIC',"delta_pct":'$pct'}' > ci-timings/static-checks.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-static-checks
          path: ci-timings/
          retention-days: 7

  # ─────────────────────────────────────────────────────────────────────────
  # Job 2: Unit tests — runs in parallel with build after static-checks
  # ─────────────────────────────────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: static-checks
    permissions:
      contents: read
    timeout-minutes: 5
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Run unit tests
        run: npx vitest run
        timeout-minutes: 4

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        working-directory: .
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## Unit Tests: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_UNIT" -gt 0 ] && pct=$(( (d-BASELINE_UNIT)*100/BASELINE_UNIT ))
          [ "$pct" -gt 30 ] && echo "::warning::Unit tests regression: ${d}s (+${pct}% vs ${BASELINE_UNIT}s)"
          mkdir -p ci-timings
          echo '{"job":"unit-tests","duration_seconds":'$d',"baseline_seconds":'$BASELINE_UNIT',"delta_pct":'$pct'}' > ci-timings/unit-tests.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-unit-tests
          path: ci-timings/
          retention-days: 7

  # ─────────────────────────────────────────────────────────────────────────
  # Job 3: Build — runs in parallel with unit-tests after static-checks
  # ─────────────────────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: static-checks
    permissions:
      contents: read
    timeout-minutes: 5
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Cache Next.js build
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: frontend/.next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}-${{ hashFiles('frontend/src/**') }}
          restore-keys: |
            next-cache-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}-
            next-cache-${{ runner.os }}-

      - name: Build
        run: npx next build
        timeout-minutes: 5

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        working-directory: .
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## Build: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_BUILD" -gt 0 ] && pct=$(( (d-BASELINE_BUILD)*100/BASELINE_BUILD ))
          [ "$pct" -gt 30 ] && echo "::warning::Build regression: ${d}s (+${pct}% vs ${BASELINE_BUILD}s)"
          mkdir -p ci-timings
          echo '{"job":"build","duration_seconds":'$d',"baseline_seconds":'$BASELINE_BUILD',"delta_pct":'$pct'}' > ci-timings/build.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-build
          path: ci-timings/
          retention-days: 7

  # ─────────────────────────────────────────────────────────────────────────
  # Job 4: Playwright smoke E2E — runs after build
  # Fork-safe: uses staging secrets only for non-fork PRs; smoke tests
  # that don't require a live backend still pass without secrets.
  # ─────────────────────────────────────────────────────────────────────────
  e2e-smoke:
    name: Playwright Smoke
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    timeout-minutes: 8
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/ms-playwright
          key: pw-browsers-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        timeout-minutes: 5

      - name: Run smoke E2E tests
        run: npx playwright test --project=smoke 2>&1 | tee ../playwright-stdout.log
        timeout-minutes: 5
        env:
          # Use staging keys for non-fork PRs; smoke tests that don't hit
          # Supabase will pass even without these env vars.
          NEXT_PUBLIC_SUPABASE_URL: ${{ github.event.pull_request.head.repo.fork == false && (secrets.SUPABASE_URL_STAGING || secrets.NEXT_PUBLIC_SUPABASE_URL) || '' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ github.event.pull_request.head.repo.fork == false && (secrets.SUPABASE_ANON_KEY_STAGING || secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY) || '' }}

      - name: Upload Playwright report + traces
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ !cancelled() }}
        with:
          name: pw-smoke-report
          path: |
            frontend/playwright-report/
            frontend/test-results/
            playwright-stdout.log
          retention-days: 7

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        working-directory: .
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## Playwright Smoke: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_SMOKE" -gt 0 ] && pct=$(( (d-BASELINE_SMOKE)*100/BASELINE_SMOKE ))
          [ "$pct" -gt 30 ] && echo "::warning::E2E smoke regression: ${d}s (+${pct}% vs ${BASELINE_SMOKE}s)"
          mkdir -p ci-timings
          echo '{"job":"e2e-smoke","duration_seconds":'$d',"baseline_seconds":'$BASELINE_SMOKE',"delta_pct":'$pct'}' > ci-timings/e2e-smoke.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-e2e-smoke
          path: ci-timings/
          retention-days: 7

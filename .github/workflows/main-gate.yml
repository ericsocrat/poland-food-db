# ═══════════════════════════════════════════════════════════════════════════════
# Main Gate — Strict quality gate for pushes to main
# CI Architecture Redesign — parallel job graph for fast feedback
# ═══════════════════════════════════════════════════════════════════════════════
# Parallel job graph:
#   static-checks ─────────────────────┐
#   unit-tests ── sonar                ├── (all complete)
#   build ──────── e2e                 │
#
# Target runtime: < 10 minutes wall-clock
# ═══════════════════════════════════════════════════════════════════════════════

name: Main Gate

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  # ── CI runtime observability baselines (seconds) ─────────────────────────
  BASELINE_STATIC: 90
  BASELINE_UNIT: 180
  BASELINE_BUILD: 120
  BASELINE_E2E: 600
  BASELINE_SONAR: 300

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Job 1: Static analysis — typecheck + lint (parallel, no dependencies)
  # ─────────────────────────────────────────────────────────────────────────
  static-checks:
    name: Typecheck & Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 5
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: TypeScript type-check
        run: npx tsc --noEmit
        timeout-minutes: 3

      - name: ESLint
        run: npx next lint
        timeout-minutes: 3

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        working-directory: .
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## Typecheck & Lint: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_STATIC" -gt 0 ] && pct=$(( (d-BASELINE_STATIC)*100/BASELINE_STATIC ))
          [ "$pct" -gt 30 ] && echo "::warning::Static checks regression: ${d}s (+${pct}% vs ${BASELINE_STATIC}s)"
          mkdir -p ci-timings
          echo '{"job":"static-checks","duration_seconds":'$d',"baseline_seconds":'$BASELINE_STATIC',"delta_pct":'$pct'}' > ci-timings/static-checks.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-mg-static-checks
          path: ci-timings/
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────
  # Job 2: Unit tests with coverage (parallel, no dependencies)
  # ─────────────────────────────────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 8
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Unit tests with coverage
        run: npx vitest run --coverage
        timeout-minutes: 5

      - name: Upload coverage for SonarCloud
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: coverage-report
          path: frontend/coverage/lcov.info
          retention-days: 1

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        working-directory: .
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## Unit Tests: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_UNIT" -gt 0 ] && pct=$(( (d-BASELINE_UNIT)*100/BASELINE_UNIT ))
          [ "$pct" -gt 30 ] && echo "::warning::Unit tests regression: ${d}s (+${pct}% vs ${BASELINE_UNIT}s)"
          mkdir -p ci-timings
          echo '{"job":"unit-tests","duration_seconds":'$d',"baseline_seconds":'$BASELINE_UNIT',"delta_pct":'$pct'}' > ci-timings/unit-tests.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-mg-unit-tests
          path: ci-timings/
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────
  # Job 3: Build + Sentry sourcemap upload (parallel, no dependencies)
  # ─────────────────────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 8
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Cache Next.js build
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: frontend/.next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}-${{ hashFiles('frontend/src/**') }}
          restore-keys: |
            next-cache-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}-
            next-cache-${{ runner.os }}-

      - name: Build (+ Sentry sourcemap upload)
        run: npx next build
        timeout-minutes: 5
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

      # Sourcemaps are uploaded automatically by @sentry/nextjs during
      # `next build` via withSentryConfig() when SENTRY_AUTH_TOKEN,
      # SENTRY_ORG, and SENTRY_PROJECT env vars are present.

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        working-directory: .
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## Build: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_BUILD" -gt 0 ] && pct=$(( (d-BASELINE_BUILD)*100/BASELINE_BUILD ))
          [ "$pct" -gt 30 ] && echo "::warning::Build regression: ${d}s (+${pct}% vs ${BASELINE_BUILD}s)"
          mkdir -p ci-timings
          echo '{"job":"build","duration_seconds":'$d',"baseline_seconds":'$BASELINE_BUILD',"delta_pct":'$pct'}' > ci-timings/build.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-mg-build
          path: ci-timings/
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────
  # Job 4: Playwright full E2E — runs after build
  # ─────────────────────────────────────────────────────────────────────────
  e2e:
    name: Playwright E2E
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    timeout-minutes: 20
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Get Playwright version
        id: pw-version
        run: echo "version=$(node -e "console.log(require('@playwright/test/package.json').version)")" >> "$GITHUB_OUTPUT"

      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: ~/.cache/ms-playwright
          key: pw-${{ runner.os }}-${{ steps.pw-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.pw-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium
        timeout-minutes: 8

      - name: Install Playwright system deps
        if: steps.pw-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium
        timeout-minutes: 5

      - name: Playwright full E2E
        run: npx playwright test 2>&1 | tee ../playwright-stdout.log
        timeout-minutes: 12
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL_STAGING || secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY_STAGING || secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_STAGING || secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Upload Playwright report + traces
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: |
            frontend/playwright-report/
            frontend/test-results/a11y-results.json
            frontend/test-results/
            playwright-stdout.log
          retention-days: 14

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        working-directory: .
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## Playwright E2E: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_E2E" -gt 0 ] && pct=$(( (d-BASELINE_E2E)*100/BASELINE_E2E ))
          [ "$pct" -gt 30 ] && echo "::warning::E2E regression: ${d}s (+${pct}% vs ${BASELINE_E2E}s)"
          mkdir -p ci-timings
          echo '{"job":"e2e","duration_seconds":'$d',"baseline_seconds":'$BASELINE_E2E',"delta_pct":'$pct'}' > ci-timings/e2e.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-mg-e2e
          path: ci-timings/
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────
  # Job 5: SonarCloud — BLOCKING quality gate (after unit-tests for coverage)
  # ─────────────────────────────────────────────────────────────────────────
  sonar:
    name: SonarCloud
    runs-on: ubuntu-latest
    needs: unit-tests
    permissions:
      contents: read
    timeout-minutes: 10
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - name: Record job start
        id: timer
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # Full history for SonarCloud new-code detection

      - name: Download coverage report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: coverage-report
          path: frontend/coverage/

      - name: SonarCloud Scan
        if: env.SONAR_TOKEN != ''
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        timeout-minutes: 5
        env:
          SONAR_HOST_URL: https://sonarcloud.io

      - name: SonarCloud Quality Gate
        if: env.SONAR_TOKEN != ''
        uses: SonarSource/sonarqube-quality-gate-action@cf038b0e0cdecfa9e56c198bbb7d21d751d62c3b # v1.2.0
        timeout-minutes: 5
        env:
          SONAR_HOST_URL: https://sonarcloud.io
        # NO continue-on-error — quality gate BLOCKS the build

      - name: CI runtime summary
        if: ${{ !cancelled() }}
        run: |
          end=$(date +%s); start=${{ steps.timer.outputs.start }}; d=$((end-start))
          echo "## SonarCloud: $((d/60))m $((d%60))s" >> "$GITHUB_STEP_SUMMARY"
          pct=0; [ "$BASELINE_SONAR" -gt 0 ] && pct=$(( (d-BASELINE_SONAR)*100/BASELINE_SONAR ))
          [ "$pct" -gt 30 ] && echo "::warning::SonarCloud regression: ${d}s (+${pct}% vs ${BASELINE_SONAR}s)"
          mkdir -p ci-timings
          echo '{"job":"sonar","duration_seconds":'$d',"baseline_seconds":'$BASELINE_SONAR',"delta_pct":'$pct'}' > ci-timings/sonar.json

      - name: Upload CI timings
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ci-timings-mg-sonar
          path: ci-timings/
          retention-days: 30

  # ─────────────────────────────────────────────────────────────────────────
  # Job 6: Failure alert — single consolidated notification
  # ─────────────────────────────────────────────────────────────────────────
  alert-on-failure:
    name: Failure Alert
    runs-on: ubuntu-latest
    needs: [static-checks, unit-tests, build, e2e, sonar]
    if: ${{ failure() && github.ref == 'refs/heads/main' }}
    permissions:
      contents: read
    steps:
      - name: Send failure alert
        env:
          ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
        run: |
          if [ -n "$ALERT_WEBHOOK_URL" ]; then
            curl -sf -X POST "$ALERT_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d '{"text": "Main Gate FAILED — https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
          fi

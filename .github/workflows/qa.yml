name: QA Tests

on:
  push:
    branches: [main]
    paths:
      - "db/**"
      - "supabase/**"
      - "RUN_QA.ps1"
      - "RUN_LOCAL.ps1"
      - "validate_eans.py"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  qa:
    name: Pipeline + QA (82 checks)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 54322:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    env:
      PGHOST: localhost
      PGPORT: 54322
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: postgres

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Apply schema migrations
        run: |
          for f in supabase/migrations/*.sql; do
            echo "Applying: $f"
            psql -f "$f"
          done

      - name: Run pipelines
        run: |
          for category in db/pipelines/*/; do
            cat_name=$(basename "$category")
            for f in $(ls "$category"PIPELINE__*.sql 2>/dev/null | sort); do
              echo "  RUN  $f"
              psql -f "$f"
              if [ $? -ne 0 ]; then
                echo "FAILED: $f"
                exit 1
              fi
            done
          done

      - name: Run QA — Data Integrity (35 checks)
        run: |
          # Strip informational checks (36+), run blocking checks only
          checks=$(sed '/-- 36\. v_master new column coverage/,$d' db/qa/QA__null_checks.sql)
          result=$(echo "$checks" | psql --tuples-only 2>&1)
          trimmed=$(echo "$result" | sed '/^\s*$/d')
          if [ -z "$trimmed" ]; then
            echo "✓ PASS (35/35 — zero violations)"
          else
            echo "✗ FAILED — violations detected:"
            echo "$result"
            exit 1
          fi

      - name: Run QA — Scoring Formula (29 checks)
        run: |
          result=$(psql --tuples-only -f db/qa/QA__scoring_formula_tests.sql 2>&1)
          trimmed=$(echo "$result" | sed '/^\s*$/d')
          if [ -z "$trimmed" ]; then
            echo "✓ PASS (29/29 — zero violations)"
          else
            echo "✗ FAILED — violations detected:"
            echo "$result"
            exit 1
          fi

      - name: Run QA — Source Coverage (informational)
        continue-on-error: true
        run: |
          result=$(psql --tuples-only -f db/qa/QA__source_coverage.sql 2>&1)
          trimmed=$(echo "$result" | sed '/^\s*$/d')
          if [ -z "$trimmed" ]; then
            echo "✓ All products have multi-source coverage"
          else
            count=$(echo "$trimmed" | wc -l)
            echo "⚠ $count items flagged for cross-validation (non-blocking)"
          fi

      - name: Run QA — EAN Checksum Validation
        run: |
          python validate_eans.py

      - name: Run QA — API Surface Validation (8 checks)
        run: |
          result=$(psql --tuples-only -f db/qa/QA__api_surfaces.sql 2>&1)
          trimmed=$(echo "$result" | sed '/^\s*$/d')
          # Check for violations (lines with non-zero counts after |)
          violations=$(echo "$trimmed" | grep -E '\|\s*[1-9]' || true)
          if [ -z "$violations" ]; then
            echo "✓ PASS (8/8 — zero violations)"
          else
            echo "✗ FAILED — API violations detected:"
            echo "$trimmed"
            exit 1
          fi

      - name: Run QA — Confidence Scoring (10 checks)
        run: |
          result=$(psql --tuples-only -f db/qa/QA__confidence_scoring.sql 2>&1)
          trimmed=$(echo "$result" | sed '/^\s*$/d')
          violations=$(echo "$trimmed" | grep -E '\|\s*[1-9]' || true)
          if [ -z "$violations" ]; then
            echo "✓ PASS (10/10 — zero violations)"
          else
            echo "✗ FAILED — Confidence scoring violations detected:"
            echo "$trimmed"
            exit 1
          fi

      - name: Confidence coverage threshold
        run: |
          # Fail if more than 1% of products have low confidence
          result=$(psql --tuples-only -c "
            SELECT COUNT(*) FROM v_product_confidence WHERE confidence_band = 'low';
          " 2>&1)
          low_count=$(echo "$result" | tr -d ' ')
          total=$(psql --tuples-only -c "SELECT COUNT(*) FROM products WHERE is_deprecated IS NOT TRUE;" 2>&1 | tr -d ' ')
          echo "Low confidence products: $low_count / $total"
          if [ "$low_count" -gt "$(echo "$total * 0.01 / 1" | bc)" ]; then
            echo "✗ FAILED — More than 1% of products have low confidence ($low_count / $total)"
            exit 1
          else
            echo "✓ PASS — Low confidence products within threshold"
          fi

      - name: Database inventory
        if: always()
        run: |
          psql -c "
            SELECT
              (SELECT COUNT(*) FROM products WHERE is_deprecated IS NOT TRUE) AS active_products,
              (SELECT COUNT(*) FROM products WHERE is_deprecated = true) AS deprecated,
              (SELECT COUNT(*) FROM servings) AS serving_rows,
              (SELECT COUNT(*) FROM nutrition_facts) AS nutrition_rows,
              (SELECT COUNT(*) FROM scores) AS scores_rows,
              (SELECT COUNT(*) FROM ingredient_ref) AS ingredient_refs,
              (SELECT COUNT(*) FROM product_ingredient) AS product_ingredients,
              (SELECT COUNT(*) FROM product_sources) AS product_source_rows,
              (SELECT COUNT(DISTINCT category) FROM products WHERE is_deprecated IS NOT TRUE) AS categories;
          "

      - name: Generate QA summary
        if: always()
        run: |
          echo "## QA Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Checks | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Data Integrity | 35 | ${{ steps.*.outcome == 'failure' && '✗ FAIL' || '✓ PASS' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scoring Formula | 29 | ✓ |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Coverage | 8 | ℹ info |" >> $GITHUB_STEP_SUMMARY
          echo "| EAN Checksum | 1 | ✓ |" >> $GITHUB_STEP_SUMMARY
          echo "| API Surfaces | 8 | ✓ |" >> $GITHUB_STEP_SUMMARY
          echo "| Confidence Scoring | 10 | ✓ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: 82 critical checks + 8 informational**" >> $GITHUB_STEP_SUMMARY

name: QA Tests

on:
  push:
    branches: [main]
    paths:
      - "db/**"
      - "supabase/**"
      - "RUN_QA.ps1"
      - "RUN_LOCAL.ps1"
      - "validate_eans.py"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      fail_on_warn:
        description: "Treat informational warnings as failures"
        required: false
        type: boolean
        default: false

jobs:
  qa:
    name: Pipeline + QA (152 checks)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 54322:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    env:
      PGHOST: localhost
      PGPORT: 54322
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: postgres

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Apply schema migrations
        run: |
          for f in supabase/migrations/*.sql; do
            echo "Applying: $f"
            psql -f "$f"
          done

      - name: Run pipelines
        run: |
          for category in db/pipelines/*/; do
            cat_name=$(basename "$category")
            for f in $(ls "$category"PIPELINE__*.sql 2>/dev/null | sort); do
              echo "  RUN  $f"
              psql -f "$f"
              if [ $? -ne 0 ]; then
                echo "FAILED: $f"
                exit 1
              fi
            done
          done

      - name: Post-pipeline fixup
        run: |
          echo "Applying CI post-pipeline fixup..."
          psql -f db/ci_post_pipeline.sql
          echo "Post-pipeline fixup complete."

      - name: Run QA via RUN_QA.ps1
        id: qa
        shell: pwsh
        run: |
          $failOnWarn = '${{ inputs.fail_on_warn }}' -eq 'true'
          if ($failOnWarn) {
            & ./RUN_QA.ps1 -Json -OutFile qa.json -FailOnWarn
          } else {
            & ./RUN_QA.ps1 -Json -OutFile qa.json
          }
          $exitCode = $LASTEXITCODE
          # Write exit code for downstream steps
          "qa_exit_code=$exitCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          # Don't fail yet — let summary + artifact steps run
          if ($exitCode -ne 0) {
            Write-Host "::warning::QA exited with code $exitCode"
          }

      - name: Upload QA results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-results
          path: qa.json
          retention-days: 30

      - name: Confidence coverage threshold
        run: |
          # Fail if more than 5% of products have low confidence
          # Note: CI threshold is 5% (not 1%) because data-enrichment migrations
          # use hardcoded product_ids and don't populate ingredient/allergen data,
          # artificially deflating confidence scores.
          low_count=$(psql --tuples-only -c "
            SELECT COUNT(*) FROM v_product_confidence WHERE confidence_band = 'low';
          " 2>&1 | tr -d ' ')
          total=$(psql --tuples-only -c "
            SELECT COUNT(*) FROM products WHERE is_deprecated IS NOT TRUE;
          " 2>&1 | tr -d ' ')
          # Integer math: threshold = total * 5 / 100 (5% floor division)
          threshold=$((total * 5 / 100))
          echo "Low confidence: $low_count / $total (threshold: $threshold)"
          if [ "$low_count" -gt "$threshold" ]; then
            echo "✗ FAILED — More than 5% of products have low confidence ($low_count / $total)"
            exit 1
          else
            echo "✓ PASS — Low confidence within threshold"
          fi

      - name: Generate QA summary
        if: always()
        shell: pwsh
        run: |
          if (-not (Test-Path 'qa.json')) {
            "## QA Summary`n`n:x: qa.json not found — QA step may have failed to start." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
            exit 0
          }
          $qa = Get-Content 'qa.json' -Raw | ConvertFrom-Json
          $sb = [System.Text.StringBuilder]::new()
          [void]$sb.AppendLine("## QA Summary")
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("| Suite | ID | Checks | Status | Runtime |")
          [void]$sb.AppendLine("|-------|----|--------|--------|---------|")
          foreach ($s in $qa.suites) {
            $icon = switch ($s.status) {
              'pass' { ':white_check_mark:' }
              'fail' { ':x:' }
              'warn' { ':warning:' }
              'error' { ':boom:' }
              default { ':grey_question:' }
            }
            $rt = if ($s.runtime_ms) { "$($s.runtime_ms) ms" } else { '—' }
            [void]$sb.AppendLine("| $($s.name) | ``$($s.suite_id)`` | $($s.checks) | $icon $($s.status) | $rt |")
          }
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("**Overall: $($qa.overall)** — $($qa.summary.passed) passed, $($qa.summary.failed) failed, $($qa.summary.warnings) warnings")
          [void]$sb.AppendLine("")
          [void]$sb.AppendLine("*Schema version: $($qa.version) · Timestamp: $($qa.timestamp)*")
          $sb.ToString() | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

      - name: Fail if QA failed
        if: always()
        shell: pwsh
        run: |
          if (-not (Test-Path 'qa.json')) { exit 1 }
          $qa = Get-Content 'qa.json' -Raw | ConvertFrom-Json
          if ($qa.overall -eq 'fail') {
            Write-Host "::error::QA FAILED — $($qa.summary.failed) check(s) failed"
            exit 1
          }
          if ($qa.overall -eq 'warn') {
            Write-Host "::warning::QA passed with warnings ($($qa.summary.warnings) flagged items)"
            # Only fail on warn if explicitly requested
            $failOnWarn = '${{ inputs.fail_on_warn }}' -eq 'true'
            if ($failOnWarn) { exit 2 }
          }
          Write-Host "QA passed: $($qa.summary.passed)/$($qa.summary.total_checks) checks"

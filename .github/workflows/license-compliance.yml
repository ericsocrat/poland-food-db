# ═══════════════════════════════════════════════════════════════════════════════
# License Compliance — Prevent GPL/AGPL contamination in production bundle
# ═══════════════════════════════════════════════════════════════════════════════
# Scans npm production dependencies for license compatibility.
# FAILS if any production dependency uses a copyleft license (GPL, AGPL, SSPL)
# which would require open-sourcing the entire application.
#
# Allowed licenses: MIT, ISC, BSD-2-Clause, BSD-3-Clause, Apache-2.0, 0BSD,
#                   CC0-1.0, CC-BY-4.0, Unlicense, BlueOak-1.0.0
#
# This is a LEGAL compliance gate. Enterprise SaaS companies enforce this to
# prevent accidental copyleft infection through transitive dependencies.
# ═══════════════════════════════════════════════════════════════════════════════

name: License Compliance

on:
  push:
    branches: [main]
    paths:
      - "frontend/package-lock.json"
      - "frontend/package.json"
  pull_request:
    branches: [main]
    paths:
      - "frontend/package-lock.json"
      - "frontend/package.json"
  # Monthly scan — catch license changes in existing packages
  schedule:
    - cron: "0 8 1 * *"  # 1st of month, 08:00 UTC

permissions:
  contents: read

concurrency:
  group: license-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-licenses:
    name: Check Dependency Licenses
    runs-on: ubuntu-latest
    timeout-minutes: 5
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - run: npm ci

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Scan production licenses
        run: |
          echo "## License Compliance Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # ── Define forbidden licenses (copyleft / viral) ───────────────
          # These would legally require open-sourcing the entire application
          FORBIDDEN="GPL-2.0;GPL-2.0-only;GPL-2.0-or-later;GPL-3.0;GPL-3.0-only;GPL-3.0-or-later;AGPL-1.0;AGPL-3.0;AGPL-3.0-only;AGPL-3.0-or-later;SSPL-1.0;EUPL-1.1;EUPL-1.2;OSL-3.0;CPAL-1.0;CPL-1.0;Sleepycat;Watcom-1.0"

          # ── Run license check (production deps only) ───────────────────
          set +e
          output=$(license-checker --production --excludePrivatePackages --failOn "$FORBIDDEN" --summary 2>&1)
          exit_code=$?
          set -e

          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "$output" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          if [ "$exit_code" -ne 0 ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "❌ **Copyleft/viral license detected in production dependencies!**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "A production dependency uses a license (GPL, AGPL, SSPL, etc.)" >> "$GITHUB_STEP_SUMMARY"
            echo "that would require open-sourcing this application." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "**Action required:** Remove or replace the offending package." >> "$GITHUB_STEP_SUMMARY"

            # Show the specific offenders
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Offending packages:" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            license-checker --production --excludePrivatePackages --onlyAllow "MIT;ISC;BSD-2-Clause;BSD-3-Clause;Apache-2.0;0BSD;CC0-1.0;CC-BY-4.0;CC-BY-3.0;Unlicense;BlueOak-1.0.0;Python-2.0;Artistic-2.0;Zlib;OFL-1.1" 2>&1 | head -50 >> "$GITHUB_STEP_SUMMARY" || true
            echo '```' >> "$GITHUB_STEP_SUMMARY"

            exit 1
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "✅ All production dependencies use permissive licenses." >> "$GITHUB_STEP_SUMMARY"

      - name: Generate full license report
        if: ${{ !cancelled() }}
        run: |
          license-checker --production --excludePrivatePackages --csv --out ../license-report.csv 2>/dev/null || true

      - name: Upload license report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.csv
          retention-days: 90
